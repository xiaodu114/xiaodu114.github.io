<!DOCTYPE html>
<html lang="zh-cmn-Hans">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>MongoDB相关 - xiaodu114.github.io</title>
    <meta name="keywords" content="MongoDB, mongo shell, 批量插入">
    <meta name="description" content="MongoDB相关的知识点……">

    <script src="/p/_/js/main.js"></script>
</head>

<body>
    <!-- github访问地址：/p/db/mongodb/index.html -->
    <div class="blog-page">

        <h1>MongoDB</h1>
        <p>MongoDB是……</p>
        <h2>添加数据</h2>
        <p>该章节介绍向MongoDB中添加数据的几种方式：</p>
        <h3>insert\insertMany</h3>
        <p>通过<inline-code>db.xxx.insertMany</inline-code>的方式新增数据</p>
        <pre ddz-class="here-need-to-handle-by-highlight" ddz-lang="javascript">
/**
 * 本JS说明：
 *      1、将这里的内容保存到JS文件（这里命名为：xxx.js）中
 *      2、在JS文件所在的文件夹“在此处打开PowerShell窗口”或者“命令提示符”
 *      3、在终端输入下面的命令
 *          示例： mongo xxx.js
 */

/**
 * mongo 其他
 *  0、添加 数据库名称 参数
 *      语法： mongo 数据库名称 xxx.js
 *      说明： 这里默认连接的是本地数据库
 *  1、添加 mongodb地址（端口）和数据库名称 参数
 *      语法： mongo IP地址:端口/数据库名称 xxx.js
 *      说明：
 *          1.1、此时你可以在JS文件中直接使用 db ,例如：print(db.getName()); print(db.version());
 *          1.2、如果设置了用户名和密码，则需要添加 -u -p --authenticationDatabase 参数
 *               示例：mongo IP地址:端口/数据库名称 xxx.js -u 用户名 -p 密码 --authenticationDatabase  admin
 *  2、在终端输入时不带 mongodb地址和数据库名称 参数
 *      语法： mongo xxx.js
 *      说明： 这种情况下，如何获取 db 以及设置了 用户名和密码 如何处理，请直接看代码
 *  …… 更多使用方式，你可以在终端输入： mongo --help
 */

//	1、数据库连接   ！！！这里需要替换！！！
let mongo = new Mongo('IP地址:端口');
mongo.getDB('admin').auth('用户名', '密码');
let db = mongo.getDB('数据库名称');

//	2、方法：批量插入数据
function realBatchInsertData(collectionName, trs) {
    try {
        db[collectionName].insertMany(trs);
    } catch (e) {
        print(e);
    }
};

//	3、准备数据以及插入数据
//		每页插入的条数
let pageSize = 100;
//		这里放置你需要插入的数据    ！！！这里需要替换！！！
let trs = [];
//		计算页数
let pageNum = Math.ceil(trs.length / pageSize);
let startTime = new Date();
print("此次共插入" + trs.length + "条记录，分页方式插入，每页" + pageSize + "条，共" + pageNum + "页");
print("---> 开始插入，计时开始。现在时间：" + startTime.toLocaleString());
for (let m = 1; m <= pageNum; m++) {
    let currentPageTrs = trs.slice((m - 1) * pageSize, m * pageSize);
    print("            第" + m + "页，共" + currentPageTrs.length + "条");
    //  ！！！这里需要替换！！！
    realBatchInsertData("表名", currentPageTrs);
}
var endTime = new Date();
print("---> 结束插入，计时结束。现在时间：" + endTime.toLocaleString() + "。耗时：" + (endTime - startTime) / 1000 + "s");
        </pre>
        <h2>备份</h2>
        <p>备份相关</p>
        <pre ddz-class="here-need-to-handle-by-highlight" ddz-lang="bash">
#	说明：目录会自动创建的
#	1、备份本地数据库（Test001）-未开启权限认证
mongodump -h localhost:27017 -d Test001 -o D:\backup\mongodb\local
mongodump -h 127.0.0.1:27017 -d Test001 -o D:\backup\mongodb\local
        </pre>
        <h2>还原</h2>
        <p>还原相关</p>
        <pre ddz-class="here-need-to-handle-by-highlight" ddz-lang="bash">
#	1、还原到本地数据库（Test002）-未开启权限认证
mongorestore -h localhost:27017 -d Test002 D:\backup\mongodb\local\Test001
mongorestore -h 127.0.0.1:27017 -d Test002 D:\backup\mongodb\local\Test001
        </pre>
        <h2>复制数据库（database）</h2>
        <p>克隆数据库的几种方式，等待添加</p>
        <h2>复制集合（collection）</h2>
        <p>克隆集合的几种方式，找到了一篇文章，文中介绍了好几种方式，感觉够全了。链接地址：<a href="https://www.mongodbmanager.com/clone-mongodb-collection" target="_blank">7 different ways to clone MongoDB connection</a></p>
        <pre ddz-class="here-need-to-handle-by-highlight" ddz-lang="javascript">
//  这里会创建一个新表"config2"，可能需要权限验证。
db.config.aggregate([ { $out: 'config2' } ]);

//  如果添加过滤条件，则只是复制其中的部分数据
db.config.aggregate([{
    $match: { ModelId : 'a' }
}, {
    $out: 'config2'
}
]);
        </pre>
        <h2>查询</h2>
        <p>该章节记录查询相关的</p>
        <div id="anchor-id-h3-001"></div>
        <h3>最新层级配置查询</h3>
        <p>这个查询的业务性很强，应用到的场景应该不多。先介绍一下具体的业务：先介绍一下模块（我们称之为模块），他有一套完整的功能，例如，添加记录、编辑记录、列表（搜索）等；首先他有一个默认的配置，其次在不同的应用中使用他时可以有不同的配置，可以在默认配置的基础上修改，再次不同的企业买了应用之后也可以在应用级的基础上对模块进行修改，甚至每个用户都有自己的配置。这里我们将默认配置、应用下的配置、企业下的配置、用户配置等叫做层级配置，并且在同意层级内还支持版本的概念，随着时间的推移以及业务的变化，我们的配置可能会有变化。</p>
        <p>说了一大堆，不知道说清楚了没有，哈哈，就当说清楚了。这个查询的是：批量查询最新的层级配置，可能是同一模块不同层级的最新配置，也可能是不同模块某一层级的最新配置……</p>
        <p>为了验证查询语句，还是先造点数据：</p>
        <pre ddz-class="here-need-to-handle-by-highlight" ddz-lang="javascript">
//	两个方法，用于生成一个随机时间
//      更多方法：https://github.com/xiaodu114/a2bei4
function getInRangeInteger(num1, num2) {
    num1 = Number.isInteger(num1) ? num1 : 0;
    num2 = Number.isInteger(num2) ? num2 : 0;
    if (num1 > num2)
        [num1, num2] = [num2, num1];
    return Math.round(Math.random() * (num2 - num1)) + num1;
}
function date_GetInRangeDate(date1, date2) {
    let v1 = new Date(date1).valueOf(),
    v2 = new Date(date2).valueOf();
    if (isNaN(v1) && isNaN(v2)) {
        v1 = 0;
        v2 = new Date().valueOf();
    } else {
        if (isNaN(v1))
            v1 = 0;
        if (isNaN(v2))
            v2 = 0;
    }
    return new Date(getInRangeInteger(Math.abs(v1 - v2)) + Math.min(v1, v2));
}

let modelIds = ["a", "b", "c"],
level1s = ["lv1_1", "lv1_2", "lv1_3"],
level2s = ["lv2_1", "lv2_2", "lv2_3"],
level3s = ["lv3_1", "lv3_2", "lv3_3"];

let trs = [];
//	标识
modelIds.forEach((modelId) => {
    for (let i = 0; i < 3; i++) {
        trs.push({
            ModelId: modelId,
            Level1: null,
            Level2: null,
            Level3: null
        });
        //	自定义：第一级
        level1s.forEach((lv1) => {
            trs.push({
                ModelId: modelId,
                Level1: lv1,
                Level2: null,
                Level3: null
            });
            //	自定义：第一级
            level2s.forEach((lv2) => {
                trs.push({
                    ModelId: modelId,
                    Level1: lv1,
                    Level2: lv2,
                    Level3: null
                });
                //	自定义：第一级
                level3s.forEach((lv3) => {
                    trs.push({
						ModelId: modelId,
						Level1: lv1,
						Level2: lv2,
						Level3: lv3
					});
                });
            });
        });
    }
});
trs.forEach(tr => {
    tr["FormConfig"] = "";
    tr["ListConfig"] = {pc:[],mobile:[]};
    tr["CreateDate"] = date_GetInRangeDate("2022-01-01 08:00:00", "2022-05-15 08:00:00");
});
db.config.insertMany(trs);           
        </pre>
        <p>下面就是查询语句了</p>
        <pre ddz-class="here-need-to-handle-by-highlight" ddz-lang="javascript">
db.getCollection('config').aggregate([{
        $match: {
            $or: [{
                    ModelId: 'a',
                    Level1: null,
                    Level2: null,
                    Level3: null
                }, {
                    ModelId: 'a',
                    Level1: 'lv1_1',
                    Level2: null,
                    Level3: null,
                }, {
                    ModelId: 'a',
                    Level1: 'lv1_1',
                    Level2: 'lv2_1',
                    Level3: null
                }, {
                    ModelId: 'a',
                    Level1: 'lv1_1',
                    Level2: 'lv2_1',
                    Level3: 'lv3_1'
                }, {
                    ModelId: 'b',
                    Level1: null,
                    Level2: null,
                    Level3: null
                }, {
                    ModelId: 'b',
                    Level1: 'lv1_2',
                    Level2: null,
                    Level3: null,
                }, {
                    ModelId: 'b',
                    Level1: 'lv1_2',
                    Level2: 'lv2_2',
                    Level3: null
                }, {
                    ModelId: 'b',
                    Level1: 'lv1_2',
                    Level2: 'lv2_2',
                    Level3: 'lv3_2'
                }
            ]
        }
    }, {
        $sort: {
            CreateDate: -1
        }
    }, {
        $group: {
            _id: {
                $concat: ['$ModelId', '->', {
                        $ifNull: ['$Level1', 'null']
                    }, '->', {
                        $ifNull: ['$Level2', 'null']
                    }, '->', {
                        $ifNull: ['$Level3', 'null']
                    }
                ]
            },
            latestItem: {
                //	$arrayElemAt: ['$items', 0]  // 获取数组第一项
                $first: '$$ROOT'
            }
        }
    }, {
        $group: {
            _id: '1',
            results: {
                $push: '$$ROOT'
            }
        }
    }, {
        $replaceRoot: {
            newRoot: {
                $arrayToObject: {
                    $map: {
                        input: '$results',
                        as: 'item',
                        in: ['$$item._id', '$$item.latestItem']
                    }
                }
            }
        }
    }
])
        </pre>
        <h3>实例数据之表单数据查询（数组内字段查询）</h3>
        <p>还是先说一下业务场景：表单基于表单构造器，表单字段是用户自己配的，所以不确定有哪些字段，因此在存储表单数据时选用的是数组结构，形如：</p>
        <pre ddz-class="here-need-to-handle-by-highlight" ddz-lang="json">
{
    _id: "",
    FormData: [{
            key: "表单控件ID",
            value: "对应的值"
        }, {
            key: "表单控件ID",
            value: "对应的值"
        },
        // ……   还有很多表单字段
    ],
    CreateDate: new Date(),
    //  ……  其他字段省略
}
        </pre>
        <p>在没有弄通用查询（<a href="/p/dotnet/mongodb/index.html" target="_blank">.net 和 mongodb</a>这篇有介绍）之前或者说刚从关系型数据转到mongodb后，这种查询感觉很别扭，于是便想着能不能在查询之前先将数据处理一下：将表单中的字段拿出来放到最外层，表单控件ID作为列名称，和"_id"处于同一层级。实现该功能至今有好几个版本了，在这里汇总一下：<a href="https://www.cnblogs.com/du-blog/p/11820110.html" target="_blank">表单生成器(Form Builder)之mongodb表单数据——整理数据</a>，这篇笔记是以前整理的</p>
        <h4>版本一</h4>
        <pre ddz-class="here-need-to-handle-by-highlight" ddz-lang="javascript">
db.instance.aggregate([{
        $addFields: {
            FormDataObj: {
                $arrayToObject: {
                    $map: {
                        input: '$FormData',
                        as: 'kv',
                        in: ['$$kv.key', '$$kv.value']
                    }
                }
            }
        }
    }, {
        $addFields: {
            'FormDataObj._id': '$_id',
            'FormDataObj.Title': '$Title',
            'FormDataObj.FormData': '$FormData',
            'FormDataObj.CreateUserId': '$CreateUserId',
            'FormDataObj.CreateUserName': '$CreateUserName',
            'FormDataObj.CreateDate': '$CreateDate',
            'FormDataObj.ModifyUserId': '$ModifyUserId',
            'FormDataObj.ModifyUserName': '$ModifyUserName',
            'FormDataObj.LastOperateDate': '$LastOperateDate',
            'FormDataObj.ModelId': '$ModelId'
        }
    }, {
        $replaceRoot: {
            newRoot: '$FormDataObj'
        }
    }
])
        </pre>
        <h4>版本二</h4>
        <pre ddz-class="here-need-to-handle-by-highlight" ddz-lang="javascript">
db.instance.aggregate([{
        $addFields: {
            FormDataObj: {
                $arrayToObject: {
                    $map: {
                        input: '$FormData',
                        as: 'kv',
                        in: ['$$kv.key', '$$kv.value']
                    }
                }
            }
        }
    }, {
        $addFields: {
            TempFormData: {
                $objectToArray: '$FormDataObj'
            }
        }
    }, {
        $addFields: {
            replaceObj: {
                $arrayToObject: {
                    $map: {
                        input: {
                            $concatArrays: ['$TempFormData', {
                                    $objectToArray: '$$ROOT'
                                }
                            ]
                        },
                        as: 'kv',
                        in: ['$$kv.k', '$$kv.v']
                    }
                }
            }
        }
    }, {
        $replaceRoot: {
            newRoot: '$replaceObj'
        }
    }, {
        $project: {
            FormDataObj: 0,
            TempFormData: 0
        }
    }
])
        </pre>
        <h4>版本三</h4>
        <pre ddz-class="here-need-to-handle-by-highlight" ddz-lang="javascript">
//  $mergeObjects 版本要求比较高，当时没有用这个
db.instance.aggregate([{
        $replaceRoot: {
            newRoot: {
                $mergeObjects: [{
                        $cond: [{
                                $isArray: '$FormData'
                            }, {
                                $arrayToObject: {
                                    $map: {
                                        input: '$FormData',
                                        as: 'kv',
                                        in: ['$$kv.key', '$$kv.value']
                                    }
                                }
                            }, {}
                        ]
                    }, '$$ROOT'
                ]
            }
        }
    }
])
        </pre>
        <h4>版本四</h4>
        <pre ddz-class="here-need-to-handle-by-highlight" ddz-lang="javascript">
db.instance.aggregate([{
        $replaceRoot: {
            newRoot: {
                $arrayToObject: {
                    $concatArrays: [{
                            $cond: [{
                                    $isArray: '$FormData'
                                }, {
                                    $map: {
                                        input: '$FormData',
                                        as: 'kv',
                                        in: {
                                            'k': '$$kv.key',
                                            'v': '$$kv.value'
                                        }
                                    }
                                }, []]
                        }, {
                            $objectToArray: '$$ROOT'
                        }
                    ]
                }
            }
        }
    }
])
        </pre>
        <h2>更新</h2>
        <p>更新相关</p>
        <h3>字段由原数据类型对象修改为数组（或者添加一个新的字段）</h3>
        <p>上面的查询章节<a href="#anchor-id-h3-001">最新层级配置查询</a>中<inline-code>ListConfig</inline-code>字段的数据类型为对象。最初存储为对象是没有问题的，但是后来有了新的需求：一条记录中可以有多个列表配置（ListConfig）。为了防止意外，原来的字段先不删除，而是在添加一个新的字段<inline-code>ListConfigs</inline-code>，将原字段添加某些属性之后添加到新数组中。</p>
        <p>为了实现上面需求有一下几种实现方式：</p>
        <h4>遍历更新</h4>
        <pre ddz-class="here-need-to-handle-by-highlight" ddz-lang="javascript">
db.config.find({}).forEach(dr => {
    dr.ListConfig._id = ISODate().valueOf().toString();
    dr.ListConfig.name = "默认列表";
    db.config.update({
        _id: dr._id
    }, {
        $set: {
            ListConfigs: [dr.ListConfig]
        }
    });
});
        </pre>
        <p>这种方式太慢了，总共有4万条数据，更新时间将近半个小时……本来想试试<inline-code>db.collection.bulkWrite</inline-code>这个，但是后来发现了后面的神器。</p>
        <h4>聚合之$out和$mergeObjects</h4>
        <pre ddz-class="here-need-to-handle-by-highlight" ddz-lang="javascript">
//  这里可能需要权限验证
db.config.aggregate([{
        $addFields: {
            ListConfigs: [{
                    $mergeObjects: [{
                            _id: ISODate().valueOf().toString(),
                            name: '默认列表'
                        },
                        '$ListConfig']
                }
            ]
        }
    }, {
        $out: 'config'
    }
])
        </pre>
        <p>这种方式太牛了，同样的数据不到一分钟就更新完了……但是来了一个新问题，我们mongodb的版本（3.4.6）太低了，不支持<inline-code>$mergeObjects</inline-code>，于是就有了后面的两种方式：</p>
        <h4>聚合之$out和$addFields、$project</h4>
        <pre ddz-class="here-need-to-handle-by-highlight" ddz-lang="javascript">
//  这里可能需要权限验证
db.config.aggregate([{
        $addFields: {
            ListConfigCopy: '$ListConfig'
        }
    }, {
        $addFields: {
            'ListConfigCopy._id': ISODate().valueOf().toString(),
            'ListConfigCopy.name': '默认列表'
        }
    }, {
        $addFields: {
            ListConfigs: ['$ListConfigCopy']
        }
    }, {
        $project: {
            ListConfigCopy: 0
        }
    }, {
        $out: 'config'
    }
])
        </pre>
        <h4>聚合之$out和$arrayToObject、$objectToArray</h4>
        <pre ddz-class="here-need-to-handle-by-highlight" ddz-lang="javascript">
//  这里可能需要权限验证
db.config.aggregate([{
        $addFields: {
            ListConfigs: [{
                    $arrayToObject: {
                        $setUnion: [{
                                $objectToArray: {
                                    _id: ISODate().valueOf().toString(),
                                    name: '默认列表'
                                }
                            }, {
                                $objectToArray: '$ListConfig'
                            }
                        ]
                    }
                }
            ]
        }
    }, {
        $out: 'config'
    }
])
        </pre>
        <h2>参考链接</h2>
        <ul>
            <li>
                <a href="https://www.modb.pro/u/311133" target="_blank">运维人在路上的个人主页 - 墨天轮</a>
            </li>
        </ul>
    </div>
</body>

</html>