<!DOCTYPE html>
<html lang="zh-cmn-Hans">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ffmpeg online - xiaodu114.github.io</title>
    <meta name="keywords" content="ffmpeg, ffmpeg.wasm, ffmpeg online, images to video">
    <meta name="description" content="ffmpeg online.">

    <style>
        .select-input-file-container {
            display: flex;
        }

        .select-input-file-container>fieldset {
            flex: 1;
        }

        #input-img-tobeselected-list {
            width: 100%;
            max-height: 388px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        #btnConvert {
            width: 100%;
            height: 36px;
            background-color: #3cb878;
            color: #fff;
            border: none;
            outline: none;
            cursor: pointer;
        }
    </style>
    <script src="/p/_/js/main.js"></script>
    <!-- <script src="/lib/coi-serviceworker/min.js"></script> -->
    <script src="coi-serviceworker.min.js"></script>
</head>

<body>
    <!-- githubè®¿é—®åœ°å€ï¼š/p/tool/ffmpeg/web/index.html -->
    <div class="blog-page">

        <h1>ffmpeg online</h1>
        <h2>æ¦‚è¿°</h2>
        <p>å¯¹ï¼Œä½ æ²¡æœ‰çœ‹é”™ï¼Œffmpegå¯ä»¥åœ¨æµè§ˆå™¨ä¸­è¿è¡Œäº†ğŸ‘ğŸ‘ğŸ‘ã€‚è¿™é‡Œéœ€è¦æ„Ÿè°¢<strong>WebAssembly</strong>ã€‚</p>
        <marked-block explain="ä¼ é€">
            <p>
                å®˜ç½‘ï¼š<a href="https://ffmpegwasm.netlify.app/" target="_blank">FFMPEG.WASM</a>
            </p>
            <p>
                GitHubï¼š<a href="https://github.com/ffmpegwasm/ffmpeg.wasm" target="_blank">GitHub -
                    ffmpegwasm/ffmpeg.wasm</a>
            </p>
            <p>
                cdnï¼š<a href="https://unpkg.com/@ffmpeg/ffmpeg/" target="_blank">UNPKG - @ffmpeg/ffmpeg</a>
            </p>
        </marked-block>
        <h2>é‡åˆ°çš„é—®é¢˜</h2>
        <h3>ä½¿ç”¨unpkgçš„é—®é¢˜</h3>
        <marked-block type="error">
            <p>
                The FetchEvent for "https://unpkg.com/@ffmpeg/ffmpeg@0.10.0/dist/ffmpeg.min.js" resulted in a network
                error response:
                Cross-Origin-Resource-Policy prevented from serving the response to the client.
            </p>
            <p>
                GET https://unpkg.com/@ffmpeg/ffmpeg@0.10.0/dist/ffmpeg.min.js net::ERR_FAILED
            </p>
        </marked-block>
        <p>è¿™ä¸ªä¹Ÿä¸æ˜¯æ¯æ¬¡éƒ½å‡ºç°ï¼Œåˆ·æ–°çš„æ—¶å€™ï¼Œæ—¶ä¸æ—¶å†’å‡ºä¸€æ¬¡â€¦â€¦è¿˜æ²¡æœ‰æ¥å¾—æ€¥ç ”ç©¶ä¸ºä»€ä¹ˆã€‚ä½ å¯ä»¥åœ¨<inline-code>script</inline-code>æ ‡ç­¾ä¸­æ·»åŠ <inline-code>crossorigin
            </inline-code>å±æ€§ã€‚
        </p>
        <h3>cross-origin isolated</h3>
        <marked-block type="error">
            <p>
                [Deprecation] SharedArrayBuffer will require cross-origin isolation as of M92, around July 2021. See
                https://developer.chrome.com/blog/enabling-shared-array-buffer/ for more details.
            </p>
            <p>
                Uncaught (in promise) ReferenceError: SharedArrayBuffer is not defined
            </p>
        </marked-block>
        <p>è·¨åŸŸéš”ç¦»ï¼Œè¿™æ˜¯é‡åˆ°çš„ç¬¬äºŒä¸ªé—®é¢˜ã€‚GitHubçš„ä»‹ç»ä¸­ä¹Ÿç»™å‡ºäº†è§£å†³åŠæ³•ï¼šå¯¹åº”é¡µé¢çš„å“åº”å¤´éƒ¨æ·»åŠ ä¸¤ä¸ªé€‰é¡¹ã€‚è¿™é‡Œä½¿ç”¨çš„æ˜¯IISï¼Œæµ‹è¯•äº†ä¸€ä¸‹æœç„¶æ²¡æœ‰é—®é¢˜ã€‚æ·»åŠ çš„headerså¦‚ä¸‹ï¼š</p>
        <pre ddz-class="here-need-to-handle-by-highlight" ddz-lang="bash">
Cross-Origin-Embedder-Policy: require-corp
Cross-Origin-Opener-Policy: same-origin
		</pre>
        <p>è¿™é‡Œè¡ç”Ÿå‡ºå¦å¤–ä¸€ä¸ªé—®é¢˜ï¼šæœåŠ¡å™¨æ˜¯æˆ‘ä»¬è‡ªå·±çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç»™é¡µé¢å“åº”æ·»åŠ headerï¼Œä½†æ˜¯å¦‚æœæœåŠ¡å™¨æˆ‘ä»¬æ§åˆ¶ä¸äº†è¯¥æ€ä¹ˆåŠï¼ˆä¾‹å¦‚ï¼šGitHubä¸­çš„é¡µé¢ï¼‰ï¼ŸæŠ±ç€è¯•è¯•çœ‹çš„æ€åº¦æŸ¥äº†ä¸€ä¸‹ï¼Œè¿˜çœŸæ‰¾åˆ°è§£å†³åŠæ³•ï¼Œå¼•ä¸€ä¸ªJSå°±èƒ½æå®šï¼Œè¿™ä¸ªçœŸçš„è§‰å¾—ğŸ‘ğŸ‘ğŸ‘ã€‚æ„Ÿè§‰æ˜¯æœåŠ¡å™¨ç«¯çš„é—®é¢˜ï¼Œä½†æ˜¯ç°åœ¨ä¸€ä¸ªJSæå®šäº†ã€‚æ³¨æ„ä¸€ä¸‹è¿™ä¸ªJSä¸èƒ½ä½¿ç”¨CDNçš„æ–¹å¼å¼•å…¥ã€‚å‚è€ƒé“¾æ¥ï¼š<a
                href="https://github.com/gzuidhof/coi-serviceworker" target="_blank">GitHub -
                gzuidhof/coi-serviceworker</a>
        </p>
        <marked-block type="warning">
            <p>
                è¿™é‡Œé‡åˆ°ä¸€ä¸ªä»¤äººè´¹è§£çš„é—®é¢˜ï¼šå¼•å…¥<inline-code>coi-serviceworker</inline-code>
                ï¼ˆå¼•å…¥æ–¹å¼æ˜¯ç”¨scriptæ ‡ç­¾,src="/lib/coi-serviceworker/min.js"ï¼‰ä¹‹å,æµè§ˆå™¨ä¸­ç¬¬ä¸€æ¬¡è®¿é—®è¯¥é¡µé¢æ—¶ä¸€ç›´åœ¨è‡ªåŠ¨åˆ·æ–°â€¦â€¦ä¸çŸ¥é“ä»€ä¹ˆé¬¼ã€‚ä¹‹åå°†è¯¥ç±»åº“æ”¾åˆ°ä¸è¯¥é¡µé¢ç›¸åŒçš„æ–‡ä»¶å¤¹ä¸‹ï¼Œæ­¤æ—¶åœ¨å¼•å…¥ï¼Œè®¿é—®é¡µé¢å°±æ­£å¸¸äº†â€¦â€¦æ‡µåœˆçš„æ˜¯ï¼Œåœ¨æ¢æˆç¬¬ä¸€æ¬¡çš„å¼•å…¥æ–¹å¼ä¹Ÿæ²¡æœ‰é—®é¢˜äº†ğŸ˜…ğŸ˜…ğŸ˜…ï¼Œåœæ»ä¸€æ®µæ—¶é—´ä¹‹åå°±åˆå¼€å§‹ä¸€ç›´åˆ·æ–°äº†â€¦â€¦
            </p>
        </marked-block>
        <h3>å›¾ç‰‡å¤ªå¤§çš„é—®é¢˜</h3>
        <p>è¿™æ˜¯ä¸€ä¸ªè‹¦é€¼çš„é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜æ„Ÿè§‰è‡ªå·±å¼„è¿™ä¸ªæœ‰ç‚¹é¸¡è‚‹äº†ã€‚é€‰äº†ä¸€å¼ 3.53MBçš„å›¾ç‰‡å’Œ10.2MBçš„éŸ³é¢‘ï¼ŒæŠ¥é”™äº†ğŸ˜“ğŸ˜“ğŸ˜“ã€‚ä¹‹ååˆæ¢äº†ä¸€ä¸ªç»„åˆ108KBçš„å›¾ç‰‡å’Œ10.2MBçš„éŸ³é¢‘ï¼Œè¿™æ¬¡æˆåŠŸäº†ã€‚3.53MBä¹Ÿä¸æ˜¯å¤ªå¤§å§ï¼
        </p>
        <marked-block type="error">
            <p>Pthread aborting at Error</p>
            <p>worker.js onmessage() captured an uncaught exception: RuntimeError: abort(OOM). Build with -s
                ASSERTIONS=1 for more
                info.</p>
            <p>RuntimeError: abort(OOM). Build with -s ASSERTIONS=1 for more info.</p>
            <p>Uncaught RuntimeError: abort(OOM). Build with -s ASSERTIONS=1 for more info.</p>
        </marked-block>
        <h2>èµ¶ç´§è¯•è¯•å§</h2>
        <p id="msg"></p>
        <h3>å›¾ç‰‡å’ŒéŸ³é¢‘åˆæˆè§†é¢‘</h3>
        <div class="select-input-file-container">
            <fieldset>
                <legend>é€‰æ‹©å›¾ç‰‡</legend>
                <div class="select-input-img-container">
                    <p><label><input id="input-file-img" type="file" accept="image/*" multiple="multiple"></label></p>
                    <div id="input-img-tobeselected-list">
                    </div>
                </div>
            </fieldset>
            <fieldset>
                <legend>é€‰æ‹©éŸ³é¢‘</legend>
                <div class="select-input-audio-container">
                    <p><input id="input-file-audio" type="file" accept="audio/*" multiple="multiple"></p>
                    <div id="input-audio-tobeselected-list">
                    </div>
                </div>
            </fieldset>
        </div>
        <p>
            <button type="button" id="btnConvert">&uarr;&rarr;è½¬&rarr;&darr;</button>
        </p>
        <h3>m3u8è½¬è§†é¢‘</h3>
        <p>
            <label>
                é€‰æ‹©ä¸€ä¸ªm3u8æ–‡ä»¶ï¼š<input id="input-file-m3u8" type="file">
            </label>
        </p>
        <marked-block type="error">
            <p>
                m3u8è½¬è§†é¢‘æ²¡æœ‰è·‘æˆåŠŸï¼Œæç¤ºå¦‚ä¸‹é”™è¯¯:
            </p>
            <p>
                [fferr] https protocol not found, recompile FFmpeg with openssl, gnutls or securetransport enabled.
            </p>
            <hr>
            <p>åœ¨å®˜ç½‘ä¸Šä¹Ÿæ‰¾åˆ°äº†ç±»ä¼¼çš„é—®é¢˜ï¼š<a href="https://hub.xn--p8jhe.tw/ffmpegwasm/ffmpeg.wasm/issues/219" target="_blank">https
                    protocol not found, recompile FFmpeg with openssl, gnutls or securetransport enabled. Â· Issue #219 Â·
                    ffmpegwasm/ffmpeg.wasm Â· GitHub</a></p>
            <p>è®°å½•ä¸€ä¸‹è¿™ä¸ªé“¾æ¥ï¼š<a href="https://askubuntu.com/questions/650577/how-to-compile-ffmpeg-with-https-support"
                    target="_blank" rel="noopener noreferrer">openssl - How to compile ffmpeg with https support - Ask
                    Ubuntu</a></p>
        </marked-block>
        <video id="video-player" controls style="max-width: 100%;"></video>

    </div>

    <script src="https://unpkg.com/@ffmpeg/ffmpeg/dist/ffmpeg.min.js" crossorigin></script>
    <script>
        const { createFFmpeg, fetchFile } = FFmpeg,
            cr = document.createRange(),
            msgDom = document.getElementById('msg');
        function resetMsg(_msg, _color) {
            msgDom.innerHTML = _msg;
            msgDom.style.color = _color;
        }
        function ffmpegInit() {
            const ffmpeg = createFFmpeg({
                corePath: 'https://unpkg.com/@ffmpeg/core/dist/ffmpeg-core.js',
                log: true
            });
            return new Promise((resolve, reject) => {
                ffmpeg.load().then(() => {
                    resolve(ffmpeg);
                }, (error) => {
                    console.error(error);
                    reject("ffmpeg.loadæ–¹æ³•å‡ºç°å¼‚å¸¸ï¼Œè¯¦è§æ§åˆ¶å°è¾“å‡ºã€‚");
                });
            });
        }
        resetMsg("ffmpegï¼šå„ä½åƒä¸‡åˆ«ç€æ€¥ï¼Œæˆ‘çš„æœ‰ç‚¹å¯Œæ€å†åŠ ä¸Šè¿™è‹¦é€¼çš„ç½‘é€Ÿâ€¦â€¦åˆ«ç€æ€¥æ“ä½œï¼Œå„ä½ç¨ç­‰ï¼Œå¥½äº†é€šçŸ¥ä½ ä»¬", "red");
        ffmpegInit().then((myFFmpeg) => {
            resetMsg("ffmpegï¼šè®©å„ä½ä¹…ç­‰äº†ï¼Œæˆ‘å‡†å¤‡å¥½äº†", "green");

            //#region å›¾ç‰‡ã€éŸ³é¢‘åˆæˆè§†é¢‘

            const inputImgDom = document.getElementById('input-file-img'),
                inputAudioDom = document.getElementById('input-file-audio'),
                btnConvertDom = document.getElementById("btnConvert"),
                inputImgShowListDom = document.getElementById("input-img-tobeselected-list"),
                inputAudioShowListDom = document.getElementById("input-audio-tobeselected-list"),
                videoPlayerDom = document.getElementById('video-player');
            let inputImgCache = [], inputAudioCache = [];
            function inputImgShowListChange() {
                if (Array.isArray(inputImgCache) && inputImgCache.length) {
                    inputImgShowListDom.innerHTML = "";
                    inputImgCache.forEach((file) => {
                        inputImgShowListDom.appendChild(cr.createContextualFragment(`
                            <p>
                                ${file.name}
                            </p>
                        `));
                    });
                }
            }
            function inputAudioShowListChange() {
                if (Array.isArray(inputAudioCache) && inputAudioCache.length) {
                    inputAudioShowListDom.innerHTML = "";
                    inputAudioCache.forEach((file) => {
                        inputAudioShowListDom.appendChild(cr.createContextualFragment(`
                            <p>
                                ${file.name}
                            </p>
                        `));
                    });
                }
            }
            inputImgDom.addEventListener('change', (eFileInput) => {
                if (eFileInput.target.files && eFileInput.target.files.length) {
                    inputImgCache = inputImgCache.concat(Array.from(eFileInput.target.files));
                }
                inputImgShowListChange();
            }, false);
            inputAudioDom.addEventListener('change', (eFileInput) => {
                if (eFileInput.target.files && eFileInput.target.files.length) {
                    inputAudioCache = inputAudioCache.concat(Array.from(eFileInput.target.files));
                }
                inputAudioShowListChange();
            }, false);

            btnConvertDom.addEventListener('click', async (eBtn) => {
                if (!inputImgCache.length) return;
                resetMsg("æ­£åœ¨å°½åŠ›è½¬æ¢ä¸­ï¼Œæ‚¨ç¨ç­‰", "green");
                let ffmpegCommandArgs = [], filterComplexArgs = [], filterComplexPartStr = "";
                //  
                for (let i = 0; i < inputImgCache.length; i++) {
                    ffmpegCommandArgs.push('-loop', '1', '-t', '5', '-i', inputImgCache[i].name);
                    filterComplexPartStr += `[${i}:v] `;
                    myFFmpeg.FS('writeFile', inputImgCache[i].name, await fetchFile(inputImgCache[i]));
                }
                filterComplexArgs.push('-filter_complex', `${filterComplexPartStr}concat=n=${inputImgCache.length}:v=1:a=0 [v]`);
                //
                if (inputAudioCache.length) {
                    for (let i = 0; i < inputAudioCache.length; i++) {
                        ffmpegCommandArgs.push('-i', inputAudioCache[i].name);
                        myFFmpeg.FS('writeFile', inputAudioCache[i].name, await fetchFile(inputAudioCache[i]));
                    }
                }
                if (filterComplexArgs.length) {
                    ffmpegCommandArgs = ffmpegCommandArgs.concat(filterComplexArgs);
                }
                if (inputImgCache.length) {
                    ffmpegCommandArgs.push('-map', "[v]");
                }
                if (inputAudioCache.length && inputImgCache.length) {
                    ffmpegCommandArgs.push('-map', inputImgCache.length + ':a');
                }
                ffmpegCommandArgs.push('output.mp4');
                await myFFmpeg.run.apply(null, ffmpegCommandArgs);
                var data = myFFmpeg.FS('readFile', 'output.mp4');
                videoPlayerDom.src = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                resetMsg("è½¬æ¢å®Œæˆï¼Œè®©æ‚¨ä¹…ç­‰äº†", "green");
            }, false);

            //#endregion

            //#region m3u8è½¬è§†é¢‘

            const eleInputFileM3u8 = document.getElementById('input-file-m3u8');
            eleInputFileM3u8.addEventListener("change", async (eFileInput) => {
                if (!(eFileInput.target.files && eFileInput.target.files.length)) return;

                let [m3u8File] = eFileInput.target.files;
                myFFmpeg.FS('writeFile', m3u8File.name, await fetchFile(m3u8File));
                let commandArgs = ["-protocol_whitelist", "file,http,https,tcp,tls,crypto", "-i", m3u8File.name, "output-form-m3u8.mp4"];
                await myFFmpeg.run.apply(null, commandArgs);
                var data = myFFmpeg.FS('readFile', 'output-form-m3u8.mp4');
                videoPlayerDom.src = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                resetMsg("è½¬æ¢å®Œæˆï¼Œè®©æ‚¨ä¹…ç­‰äº†", "green");
            });

            //#endregion

        }, (errorMsg) => {
            resetMsg(errorMsg, "red");
        });
    </script>
</body>

</html>